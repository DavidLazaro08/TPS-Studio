# MainViewController Refactoring Audit

## üìä ESTADO ACTUAL

**Archivo:** [MainViewController.java](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java)  
**L√≠neas:** 1594  
**M√©todos:** 37  
**Estado:** ‚ö†Ô∏è **God Controller** con m√∫ltiples responsabilidades mezcladas

---

## 1Ô∏è‚É£ AN√ÅLISIS DE RESPONSABILIDADES

### Bloques Funcionales Identificados

#### üé® **A. UI Wiring & Lifecycle** (DEBE quedarse en Controller)
- **L√≠neas:** 29-108, 1539-1592
- **M√©todos:** [initialize()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#93-109), [setupCanvas()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#110-130), [onTogglePropiedades()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1539-1543), [togglePanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1544-1593)
- **Responsabilidad:** Inicializaci√≥n FXML, bindings, animaciones de paneles
- **Veredicto:** ‚úÖ **PURA UI** ‚Üí Se queda en [MainViewController](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#27-1594)

#### üñºÔ∏è **B. Canvas Rendering & Interaction** (DEBE extraerse)
- **L√≠neas:** 731-891, 895-1180
- **M√©todos:** 
  - [dibujarCanvas()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#731-892) (160 l√≠neas)
  - [onCanvasMousePressed()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#895-964), [onCanvasMouseDragged()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#965-1096), [onCanvasMouseMoved()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1097-1133), [onCanvasMouseReleased()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1178-1181)
  - [getDragModeForMouseEvent()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1134-1170), [ensurePropertiesPanelVisible()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1171-1177)
- **Responsabilidad:** 
  - Renderizado de tarjeta CR80, elementos, gu√≠as, sangrado
  - Detecci√≥n de selecci√≥n, drag & drop, resize con handles
  - Gesti√≥n de zoom, coordenadas, cursores
- **Veredicto:** ‚ö†Ô∏è **L√ìGICA + RENDER** ‚Üí Extraer a `EditorCanvasManager`
- **Estado que necesita:**
  - `zoomLevel`, `elementoSeleccionado`, `proyectoActual`
  - `currentDragMode`, `dragStartX/Y`, `elementStartX/Y/W/H`
  - Constantes: `CARD_WIDTH`, `CARD_HEIGHT`, `BLEED_MARGIN`, `SAFETY_MARGIN`, `HANDLE_SIZE`

#### üéõÔ∏è **C. Properties Panel Construction** (DEBE extraerse)
- **L√≠neas:** 278-649
- **M√©todos:** [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650) (370 l√≠neas!)
- **Responsabilidad:** 
  - Construcci√≥n din√°mica del panel de propiedades seg√∫n tipo de elemento
  - Bindings bidireccionales: TextFields ‚Üî Elemento properties
  - Validaciones UI (mantener proporci√≥n, l√≠mites de tama√±o)
  - Listeners para cambios en tiempo real
- **Veredicto:** ‚ö†Ô∏è **UI + L√ìGICA MEZCLADA** ‚Üí Extraer a `PropertiesPanelController`
- **Problemas detectados:**
  - Flag `isUpdatingTextFields` para evitar bucles ‚Üí indica acoplamiento fr√°gil
  - L√≥gica de proporci√≥n de im√°genes mezclada con UI
  - Validaciones inline sin separaci√≥n de concerns

#### üîÑ **D. Mode Management** (DEBE extraerse)
- **L√≠neas:** 133-157, 161-276, 653-727
- **M√©todos:** 
  - [switchMode()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#143-158), [onModeEdit()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#133-137), [onModeExport()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#138-142)
  - [buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277) (115 l√≠neas)
  - [buildExportPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#653-728) (75 l√≠neas)
- **Responsabilidad:** 
  - Cambio entre modos DESIGN/PRODUCTION
  - Construcci√≥n de paneles laterales seg√∫n modo
  - Gesti√≥n de toolbox, layers, export controls
- **Veredicto:** ‚ö†Ô∏è **L√ìGICA DE ESTADO** ‚Üí Extraer a `ModeManager`
- **Estado que maneja:**
  - `currentMode` (AppMode enum)
  - Paneles din√°micos: `leftPanel`, `rightPanel`

#### üìÅ **E. Project Management** (DEBE extraerse)
- **L√≠neas:** 1353-1422, 1426-1537
- **M√©todos:** 
  - [onNuevoProyecto()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1353-1357), [onAbrirProyecto()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1358-1362), [onGuardarProyecto()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1363-1367), [onExportarProyecto()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1368-1372)
  - [onNuevoCR80()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1412-1423)
  - [onA√±adirTexto()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1426-1443), [onA√±adirImagen()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1444-1469), [onA√±adirFondo()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1479-1538), [onEliminarElemento()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1470-1478)
  - [mostrarDialogoFitMode()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1182-1250), [abrirEditorExterno()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1251-1297), [recargarFondo()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1298-1350)
- **Responsabilidad:** 
  - CRUD de proyectos y elementos
  - Gesti√≥n de lista de proyectos (`proyectos` ObservableList)
  - Di√°logos de selecci√≥n de archivos
  - L√≥gica de fondo (fit modes, edici√≥n externa, recarga)
- **Veredicto:** ‚ö†Ô∏è **L√ìGICA DE NEGOCIO** ‚Üí Extraer a `ProjectManager` (Service)
- **Estado que maneja:**
  - `proyectos` (ObservableList<Proyecto>)
  - `proyectoActual` (Proyecto)

#### üîç **F. Zoom & View Controls** (PUEDE quedarse o extraerse)
- **L√≠neas:** 1373-1410
- **M√©todos:** [onZoomIn()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1373-1380), [onZoomOut()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1381-1388), [actualizarZoom()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1389-1393), [onToggleFrenteDorso()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1394-1406), [onToggleGuias()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1407-1411)
- **Responsabilidad:** Control de zoom, toggles de vista
- **Veredicto:** ü§î **H√çBRIDO** ‚Üí Podr√≠a ir a ViewModel o quedarse en Controller
- **Estado:**
  - `zoomLevel` (double)
  - `toggleFrenteDorso`, `toggleGuias` (ToggleButtons)

---

## 2Ô∏è‚É£ VIOLACIONES MVVM DETECTADAS

### üö® Cr√≠ticas

1. **L√≥gica de negocio en Controller**
   - [onA√±adirTexto()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1426-1443), [onA√±adirImagen()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1444-1469), [onA√±adirFondo()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1479-1538) ‚Üí Deber√≠an delegar a Service
   - [mostrarDialogoFitMode()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1182-1250) ‚Üí L√≥gica de decisi√≥n mezclada con UI

2. **Estado no observable**
   - `zoomLevel`, `currentMode`, `elementoSeleccionado`, `proyectoActual` ‚Üí Deber√≠an ser Properties en ViewModel
   - Cambios de estado no notifican autom√°ticamente ‚Üí Llamadas manuales a [dibujarCanvas()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#731-892), [buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277)

3. **Acoplamiento a nodos UI**
   - [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650) construye UI directamente ‚Üí Dificulta testing
   - [dibujarCanvas()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#731-892) accede directamente a `canvas` ‚Üí No se puede testear sin JavaFX

4. **Listeners fr√°giles**
   - Flag `isUpdatingTextFields` para evitar bucles ‚Üí Indica dise√±o fr√°gil
   - Listeners inline en [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650) ‚Üí Dificulta mantenimiento

### ‚ö†Ô∏è Moderadas

5. **Responsabilidad √∫nica violada**
   - Controller hace: UI wiring + rendering + gesti√≥n de estado + l√≥gica de negocio + persistencia

6. **Testabilidad**
   - Imposible testear l√≥gica sin inicializar JavaFX
   - No hay separaci√≥n entre "qu√© mostrar" (ViewModel) y "c√≥mo mostrarlo" (View)

---

## 3Ô∏è‚É£ AGRUPACI√ìN POR M√ìDULOS PROPUESTOS

### üì¶ **Arquitectura Objetivo**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    MainViewController                        ‚îÇ
‚îÇ  - initialize()                                              ‚îÇ
‚îÇ  - setupCanvas() [delegaci√≥n]                                ‚îÇ
‚îÇ  - Bindings FXML ‚Üî ViewModel                                 ‚îÇ
‚îÇ  - Orquestaci√≥n de managers                                  ‚îÇ
‚îÇ  - Animaciones de paneles (togglePanel)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚ñ∫ EditorCanvasManager (Canvas rendering + interaction)
         ‚îÇ    - dibujarCanvas()
         ‚îÇ    - Mouse events (pressed, dragged, moved, released)
         ‚îÇ    - getDragModeForMouseEvent()
         ‚îÇ    - Gesti√≥n de zoom visual
         ‚îÇ    - Constantes CR80
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚ñ∫ PropertiesPanelController (Panel derecho)
         ‚îÇ    - buildPropertiesPanel()
         ‚îÇ    - Bindings bidireccionales UI ‚Üî ViewModel
         ‚îÇ    - Validaciones UI (proporci√≥n, l√≠mites)
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚ñ∫ ModeManager (Dise√±o/Producci√≥n)
         ‚îÇ    - switchMode()
         ‚îÇ    - buildEditPanels()
         ‚îÇ    - buildExportPanels()
         ‚îÇ    - Gesti√≥n de paneles din√°micos
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚ñ∫ ProjectManager (Service - l√≥gica de negocio)
         ‚îÇ    - CRUD proyectos
         ‚îÇ    - CRUD elementos
         ‚îÇ    - Gesti√≥n de fondos (fit modes, edici√≥n externa)
         ‚îÇ    - Di√°logos de archivos
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚ñ∫ MainViewModel (Estado global)
         ‚îÇ    - currentModeProperty (ObjectProperty<AppMode>)
         ‚îÇ    - proyectoActualProperty (ObjectProperty<Proyecto>)
         ‚îÇ    - proyectosProperty (ObservableList<Proyecto>)
         ‚îÇ    - zoomLevelProperty (DoubleProperty)
         ‚îÇ
         ‚îî‚îÄ‚îÄ‚ñ∫ EditorViewModel (Estado del editor)
              - elementoSeleccionadoProperty (ObjectProperty<Elemento>)
              - mostrandoFrenteProperty (BooleanProperty)
              - mostrarGuiasProperty (BooleanProperty)
              - Propiedades editables del elemento seleccionado
```

---

## 4Ô∏è‚É£ DEPENDENCIAS PELIGROSAS

### üî¥ **Acoplamiento Cr√≠tico**

1. **[buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277) ‚Üî [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650)**
   - [buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277) llama a [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650) al final
   - Ambos acceden a `elementoSeleccionado`, `proyectoActual`
   - **Riesgo:** Extraer uno sin el otro rompe el flujo

2. **[dibujarCanvas()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#731-892) ‚Üî Estado global**
   - Accede a: `proyectoActual`, `elementoSeleccionado`, `zoomLevel`, `toggleGuias`, `toggleFrenteDorso`
   - **Riesgo:** Mover estado a ViewModel requiere cambiar todas las referencias

3. **Listeners en [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650)**
   - Listeners inline llaman a [dibujarCanvas()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#731-892), [buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277)
   - **Riesgo:** Extraer panel requiere exponer callbacks o eventos

4. **Mouse events ‚Üî Selecci√≥n**
   - [onCanvasMousePressed()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#895-964) modifica `elementoSeleccionado`
   - Esto dispara [buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277) ‚Üí [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650)
   - **Riesgo:** Ciclo de dependencias fr√°gil

### üü° **Acoplamiento Moderado**

5. **[ensurePropertiesPanelVisible()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1171-1177)**
   - Accede a `togglePropiedades` (nodo FXML)
   - Llamado desde m√∫ltiples lugares
   - **Riesgo:** Extraer l√≥gica requiere callback al Controller

6. **Constantes compartidas**
   - `CARD_WIDTH`, `CARD_HEIGHT`, `BLEED_MARGIN`, etc.
   - Usadas en: [dibujarCanvas()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#731-892), [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650), [onA√±adirFondo()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1479-1538)
   - **Soluci√≥n:** Mover a clase `CR80Constants` o `EditorConfig`

---

## 5Ô∏è‚É£ PLAN INCREMENTAL DE REFACTORING

### üéØ **Principios**

- ‚úÖ Refactor quir√∫rgico, no reescritura
- ‚úÖ Comportamiento id√©ntico en cada paso
- ‚úÖ Commits peque√±os y verificables
- ‚úÖ No tocar FXML salvo imprescindible

---

### **PASO 1: Crear ViewModels y migrar estado** (‚è±Ô∏è ~2h)

#### Acciones

1. **Crear `EditorViewModel`**
   ```java
   public class EditorViewModel {
       private final ObjectProperty<Elemento> elementoSeleccionado = new SimpleObjectProperty<>();
       private final BooleanProperty mostrandoFrente = new SimpleBooleanProperty(true);
       private final BooleanProperty mostrarGuias = new SimpleBooleanProperty(false);
       
       // Getters/setters + property methods
   }
   ```

2. **Crear [MainViewModel](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/viewmodel/MainViewModel.java#6-29) (expandir el existente)**
   ```java
   public class MainViewModel {
       private final ObjectProperty<AppMode> currentMode = new SimpleObjectProperty<>(AppMode.PRODUCTION);
       private final ObjectProperty<Proyecto> proyectoActual = new SimpleObjectProperty<>();
       private final ObservableList<Proyecto> proyectos = FXCollections.observableArrayList();
       private final DoubleProperty zoomLevel = new SimpleDoubleProperty(1.3);
       
       // Getters/setters + property methods
   }
   ```

3. **En [MainViewController](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#27-1594):**
   - Instanciar ViewModels en [initialize()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#93-109)
   - Reemplazar campos primitivos por llamadas a ViewModel:
     ```java
     // Antes:
     private double zoomLevel = 1.3;
     
     // Despu√©s:
     private MainViewModel mainViewModel;
     private EditorViewModel editorViewModel;
     
     // En initialize():
     mainViewModel = new MainViewModel();
     editorViewModel = new EditorViewModel();
     
     // En m√©todos:
     mainViewModel.getZoomLevel() // en lugar de zoomLevel
     ```

4. **A√±adir listeners para sincronizar UI:**
   ```java
   mainViewModel.proyectoActualProperty().addListener((obs, old, newVal) -> {
       dibujarCanvas();
   });
   
   editorViewModel.elementoSeleccionadoProperty().addListener((obs, old, newVal) -> {
       buildEditPanels();
       dibujarCanvas();
   });
   ```

#### Validaci√≥n

- [ ] App arranca sin errores
- [ ] Zoom funciona igual
- [ ] Selecci√≥n de elementos funciona
- [ ] Cambio frente/dorso funciona
- [ ] Toggles de gu√≠as funcionan

#### Archivos modificados

- [MainViewModel.java](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/viewmodel/MainViewModel.java) (expandir)
- `EditorViewModel.java` (nuevo)
- [MainViewController.java](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java) (reemplazar campos por ViewModel)

---

### **PASO 2: Extraer `EditorCanvasManager`** (‚è±Ô∏è ~3h)

#### Acciones

1. **Crear clase `EditorCanvasManager`**
   ```java
   public class EditorCanvasManager {
       private final Canvas canvas;
       private final MainViewModel mainViewModel;
       private final EditorViewModel editorViewModel;
       
       // Drag state
       private DragMode currentDragMode = DragMode.NONE;
       private double dragStartX, dragStartY;
       private double elementStartX, elementStartY, elementStartW, elementStartH;
       
       // Constantes CR80
       public static final double CARD_WIDTH = 342.4;
       public static final double CARD_HEIGHT = 215.92;
       // ... resto de constantes
       
       public EditorCanvasManager(Canvas canvas, MainViewModel mainVM, EditorViewModel editorVM) {
           this.canvas = canvas;
           this.mainViewModel = mainVM;
           this.editorViewModel = editorVM;
           setupMouseHandlers();
       }
       
       private void setupMouseHandlers() {
           canvas.setOnMousePressed(this::onCanvasMousePressed);
           canvas.setOnMouseDragged(this::onCanvasMouseDragged);
           canvas.setOnMouseMoved(this::onCanvasMouseMoved);
           canvas.setOnMouseReleased(this::onCanvasMouseReleased);
       }
       
       public void dibujarCanvas() { /* mover l√≥gica */ }
       private void onCanvasMousePressed(MouseEvent e) { /* mover l√≥gica */ }
       // ... resto de m√©todos
   }
   ```

2. **En [MainViewController](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#27-1594):**
   - Eliminar m√©todos de canvas (dibujarCanvas, mouse events, getDragModeForMouseEvent)
   - Eliminar constantes CR80
   - Eliminar estado de drag
   - Instanciar manager:
     ```java
     private EditorCanvasManager canvasManager;
     
     // En initialize():
     canvasManager = new EditorCanvasManager(canvas, mainViewModel, editorViewModel);
     ```
   - Reemplazar llamadas:
     ```java
     // Antes:
     dibujarCanvas();
     
     // Despu√©s:
     canvasManager.dibujarCanvas();
     ```

3. **Problema: [ensurePropertiesPanelVisible()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1171-1177)**
   - Canvas manager necesita abrir panel de propiedades
   - **Soluci√≥n:** Callback funcional
     ```java
     public class EditorCanvasManager {
         private Runnable onElementSelected;
         
         public void setOnElementSelected(Runnable callback) {
             this.onElementSelected = callback;
         }
         
         private void onCanvasMousePressed(MouseEvent e) {
             // ... l√≥gica de selecci√≥n
             if (nuevoSeleccionado != null) {
                 editorViewModel.setElementoSeleccionado(nuevoSeleccionado);
                 if (onElementSelected != null) {
                     onElementSelected.run();
                 }
             }
         }
     }
     
     // En MainViewController:
     canvasManager.setOnElementSelected(this::ensurePropertiesPanelVisible);
     ```

#### Validaci√≥n

- [ ] Selecci√≥n de elementos funciona
- [ ] Drag & drop funciona
- [ ] Resize con handles funciona
- [ ] Cursores cambian correctamente
- [ ] Panel de propiedades se abre al seleccionar
- [ ] Renderizado id√©ntico (gu√≠as, sangrado, elementos)

#### Archivos

- `EditorCanvasManager.java` (nuevo, ~400 l√≠neas)
- [MainViewController.java](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java) (eliminar ~450 l√≠neas)

---

### **PASO 3: Extraer `PropertiesPanelController`** (‚è±Ô∏è ~4h)

#### Acciones

1. **Crear clase `PropertiesPanelController`**
   ```java
   public class PropertiesPanelController {
       private final EditorViewModel editorViewModel;
       private boolean isUpdatingTextFields = false;
       
       public PropertiesPanelController(EditorViewModel editorVM) {
           this.editorViewModel = editorVM;
       }
       
       public VBox buildPropertiesPanel(Runnable onPropertyChanged) {
           VBox props = new VBox(8);
           props.setPadding(new Insets(30));
           // ... l√≥gica de construcci√≥n
           
           // En listeners:
           txtX.textProperty().addListener((obs, old, newVal) -> {
               if (!isUpdatingTextFields) {
                   try {
                       editorViewModel.getElementoSeleccionado().setX(Double.parseDouble(newVal));
                       onPropertyChanged.run(); // Callback para redibujar canvas
                   } catch (NumberFormatException ignored) {}
               }
           });
           
           return props;
       }
   }
   ```

2. **En [MainViewController](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#27-1594):**
   - Eliminar [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650)
   - Eliminar flag `isUpdatingTextFields`
   - Instanciar controller:
     ```java
     private PropertiesPanelController propertiesController;
     
     // En initialize():
     propertiesController = new PropertiesPanelController(editorViewModel);
     ```
   - Reemplazar en [buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277):
     ```java
     // Antes:
     buildPropertiesPanel();
     
     // Despu√©s:
     VBox propsContent = propertiesController.buildPropertiesPanel(() -> {
         canvasManager.dibujarCanvas();
     });
     
     ScrollPane scrollPane = new ScrollPane(propsContent);
     // ... configuraci√≥n scrollPane
     rightPanel.getChildren().add(scrollPane);
     ```

3. **Problema: Acceso a constantes CR80**
   - [buildPropertiesPanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#278-650) usa `CARD_WIDTH`, `CARD_HEIGHT`, `BLEED_MARGIN`
   - **Soluci√≥n:** Usar constantes de `EditorCanvasManager` o crear clase `CR80Constants`

#### Validaci√≥n

- [ ] Panel de propiedades se construye correctamente
- [ ] Cambios en TextFields actualizan elemento
- [ ] Cambios en elemento actualizan TextFields (sin bucles)
- [ ] Proporci√≥n de im√°genes funciona
- [ ] ColorPicker, ComboBox, Spinner funcionan
- [ ] Botones de reemplazo funcionan

#### Archivos

- `PropertiesPanelController.java` (nuevo, ~370 l√≠neas)
- [MainViewController.java](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java) (eliminar ~370 l√≠neas)

---

### **PASO 4: Extraer `ModeManager`** (‚è±Ô∏è ~2h)

#### Acciones

1. **Crear clase `ModeManager`**
   ```java
   public class ModeManager {
       private final VBox leftPanel;
       private final VBox rightPanel;
       private final MainViewModel mainViewModel;
       private final EditorViewModel editorViewModel;
       private final PropertiesPanelController propertiesController;
       private final Runnable onCanvasRedraw;
       
       public ModeManager(VBox leftPanel, VBox rightPanel, 
                          MainViewModel mainVM, EditorViewModel editorVM,
                          PropertiesPanelController propsCtrl, Runnable onCanvasRedraw) {
           // ...
       }
       
       public void switchMode(AppMode newMode) {
           mainViewModel.setCurrentMode(newMode);
           leftPanel.getChildren().clear();
           rightPanel.getChildren().clear();
           
           if (newMode == AppMode.DESIGN) {
               buildEditPanels();
           } else {
               buildExportPanels();
           }
           
           onCanvasRedraw.run();
       }
       
       private void buildEditPanels() { /* mover l√≥gica */ }
       private void buildExportPanels() { /* mover l√≥gica */ }
   }
   ```

2. **En [MainViewController](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#27-1594):**
   - Eliminar [switchMode()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#143-158), [buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277), [buildExportPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#653-728)
   - Instanciar manager:
     ```java
     private ModeManager modeManager;
     
     // En initialize():
     modeManager = new ModeManager(leftPanel, rightPanel, mainViewModel, editorViewModel,
                                    propertiesController, () -> canvasManager.dibujarCanvas());
     ```
   - Reemplazar en [onModeEdit()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#133-137), [onModeExport()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#138-142):
     ```java
     @FXML
     private void onModeEdit() {
         modeManager.switchMode(AppMode.DESIGN);
     }
     ```

3. **Problema: [buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277) necesita callbacks**
   - Botones de toolbox llaman a [onA√±adirTexto()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1426-1443), etc.
   - **Soluci√≥n:** Pasar callbacks en constructor
     ```java
     public ModeManager(..., Runnable onAddText, Runnable onAddImage, Runnable onAddBackground) {
         // ...
     }
     
     // En buildEditPanels():
     btnTexto.setOnAction(e -> onAddText.run());
     ```

#### Validaci√≥n

- [ ] Cambio de modo funciona
- [ ] Paneles se reconstruyen correctamente
- [ ] Toolbox funciona (botones activos)
- [ ] Lista de capas funciona
- [ ] Panel de exportaci√≥n funciona

#### Archivos

- `ModeManager.java` (nuevo, ~200 l√≠neas)
- [MainViewController.java](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java) (eliminar ~200 l√≠neas)

---

### **PASO 5: Extraer `ProjectManager` (Service)** (‚è±Ô∏è ~3h)

#### Acciones

1. **Crear clase `ProjectManager`**
   ```java
   public class ProjectManager {
       private final MainViewModel mainViewModel;
       private final EditorViewModel editorViewModel;
       
       public ProjectManager(MainViewModel mainVM, EditorViewModel editorVM) {
           // ...
       }
       
       public void crearNuevoCR80() {
           int numero = mainViewModel.getProyectos().size() + 1;
           Proyecto nuevoProyecto = new Proyecto("Tarjeta CR80 #" + numero);
           mainViewModel.getProyectos().add(nuevoProyecto);
           mainViewModel.setProyectoActual(nuevoProyecto);
       }
       
       public void a√±adirTexto() {
           Proyecto proyecto = mainViewModel.getProyectoActual();
           if (proyecto == null) return;
           
           int num = proyecto.getElementosActuales().size() + 1;
           TextoElemento texto = new TextoElemento("Texto " + num, 50, 50);
           texto.setWidth(150);
           proyecto.getElementosActuales().add(texto);
           editorViewModel.setElementoSeleccionado(texto);
       }
       
       public void a√±adirImagen(Window ownerWindow) {
           // ... l√≥gica con FileChooser
       }
       
       public void a√±adirFondo(Window ownerWindow) {
           // ... l√≥gica con FileChooser + di√°logo fit mode
       }
       
       public void eliminarElemento() {
           // ...
       }
       
       public FondoFitMode mostrarDialogoFitMode() {
           // ... mover l√≥gica de di√°logo
       }
       
       public void abrirEditorExterno(ImagenFondoElemento fondo) {
           // ...
       }
       
       public void recargarFondo(ImagenFondoElemento fondo) {
           // ...
       }
       
       // Placeholders para futuro
       public void nuevoProyecto() { /* TODO */ }
       public void abrirProyecto() { /* TODO */ }
       public void guardarProyecto() { /* TODO */ }
       public void exportarProyecto() { /* TODO */ }
   }
   ```

2. **En [MainViewController](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#27-1594):**
   - Eliminar m√©todos de proyecto/elementos
   - Instanciar manager:
     ```java
     private ProjectManager projectManager;
     
     // En initialize():
     projectManager = new ProjectManager(mainViewModel, editorViewModel);
     ```
   - Reemplazar en m√©todos FXML:
     ```java
     @FXML
     private void onNuevoCR80() {
         projectManager.crearNuevoCR80();
         canvasManager.dibujarCanvas();
     }
     
     private void onA√±adirTexto() {
         projectManager.a√±adirTexto();
         ensurePropertiesPanelVisible();
         modeManager.refreshPanels(); // Nuevo m√©todo para rebuild
         canvasManager.dibujarCanvas();
     }
     ```

3. **Problema: Di√°logos necesitan Window owner**
   - FileChooser, Alerts necesitan `canvas.getScene().getWindow()`
   - **Soluci√≥n:** Pasar Window en m√©todos que lo necesiten

#### Validaci√≥n

- [ ] Crear nuevo CR80 funciona
- [ ] A√±adir texto funciona
- [ ] A√±adir imagen funciona (FileChooser)
- [ ] A√±adir fondo funciona (FileChooser + di√°logo)
- [ ] Eliminar elemento funciona
- [ ] Edici√≥n externa funciona
- [ ] Recarga de fondo funciona

#### Archivos

- `ProjectManager.java` (nuevo, ~350 l√≠neas)
- [MainViewController.java](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java) (eliminar ~350 l√≠neas)

---

## 6Ô∏è‚É£ IMPACTO ESTIMADO

### üìä **Distribuci√≥n de C√≥digo**

| Clase | L√≠neas Aprox. | Responsabilidad |
|-------|---------------|-----------------|
| **MainViewController** | ~250 | Orquestaci√≥n, FXML bindings, animaciones |
| **EditorCanvasManager** | ~400 | Rendering, mouse events, drag & drop |
| **PropertiesPanelController** | ~370 | Panel de propiedades, bindings UI |
| **ModeManager** | ~200 | Cambio de modos, construcci√≥n de paneles |
| **ProjectManager** | ~350 | CRUD proyectos/elementos, di√°logos |
| **MainViewModel** | ~50 | Estado global (modo, proyecto, zoom) |
| **EditorViewModel** | ~50 | Estado del editor (selecci√≥n, toggles) |
| **TOTAL** | ~1670 | (Original: 1594 + overhead de separaci√≥n) |

### ‚úÖ **Qu√© queda en MainViewController**

- [initialize()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#93-109) ‚Üí Instanciar managers y ViewModels
- [setupCanvas()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#110-130) ‚Üí Delegar a `canvasManager`
- M√©todos FXML (`@FXML`) ‚Üí Delegar a managers
- [togglePanel()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1544-1593) ‚Üí Animaciones de paneles (pura UI)
- [ensurePropertiesPanelVisible()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#1171-1177) ‚Üí L√≥gica de toggle
- Listeners de ViewModel ‚Üí Sincronizar UI con estado
- **~250 l√≠neas** de c√≥digo limpio y enfocado

### üîÑ **Qu√© se mueve a ViewModel**

- `currentMode` ‚Üí `MainViewModel.currentModeProperty()`
- `proyectoActual` ‚Üí `MainViewModel.proyectoActualProperty()`
- `proyectos` ‚Üí `MainViewModel.proyectosProperty()`
- `zoomLevel` ‚Üí `MainViewModel.zoomLevelProperty()`
- `elementoSeleccionado` ‚Üí `EditorViewModel.elementoSeleccionadoProperty()`
- `mostrandoFrente` ‚Üí `EditorViewModel.mostrandoFrenteProperty()` (desde Proyecto)
- `mostrarGuias` ‚Üí `EditorViewModel.mostrarGuiasProperty()` (desde toggleGuias)

### üõ†Ô∏è **Qu√© se mueve a Services**

- CRUD de proyectos ‚Üí `ProjectManager`
- CRUD de elementos ‚Üí `ProjectManager`
- Di√°logos de archivos ‚Üí `ProjectManager`
- L√≥gica de fondos ‚Üí `ProjectManager`
- (Futuro) Persistencia ‚Üí `ProjectService` (nuevo)
- (Futuro) Exportaci√≥n ‚Üí `ExportService` (nuevo)

---

## 7Ô∏è‚É£ CHECKLIST DE VALIDACI√ìN POR PASO

### ‚úÖ **Despu√©s de cada paso:**

1. **Compilaci√≥n**
   - [ ] Proyecto compila sin errores
   - [ ] No hay warnings cr√≠ticos

2. **Funcionalidad b√°sica**
   - [ ] App arranca correctamente
   - [ ] Login funciona (si aplica)
   - [ ] Transici√≥n a MainView funciona

3. **Modo Producci√≥n**
   - [ ] Lista de proyectos visible
   - [ ] Crear nuevo CR80 funciona
   - [ ] Seleccionar proyecto funciona
   - [ ] Canvas muestra tarjeta correctamente

4. **Modo Dise√±o**
   - [ ] Cambio a modo Dise√±o funciona
   - [ ] Toolbox visible y funcional
   - [ ] A√±adir texto funciona
   - [ ] A√±adir imagen funciona
   - [ ] A√±adir fondo funciona
   - [ ] Lista de capas funciona

5. **Interacci√≥n Canvas**
   - [ ] Selecci√≥n de elementos funciona
   - [ ] Drag & drop funciona
   - [ ] Resize con handles funciona
   - [ ] Cursores cambian correctamente

6. **Panel Propiedades**
   - [ ] Se abre al seleccionar elemento
   - [ ] Campos muestran valores correctos
   - [ ] Cambios en campos actualizan elemento
   - [ ] Cambios en elemento actualizan campos
   - [ ] No hay bucles infinitos

7. **Controles de Vista**
   - [ ] Zoom in/out funciona
   - [ ] Toggle frente/dorso funciona
   - [ ] Toggle gu√≠as funciona
   - [ ] Toggle panel propiedades funciona

8. **Regresi√≥n**
   - [ ] No se rompi√≥ funcionalidad existente
   - [ ] Animaciones funcionan igual
   - [ ] Rendimiento similar

---

## 8Ô∏è‚É£ RIESGOS Y MITIGACIONES

### üö® **Riesgos Altos**

1. **Bucles infinitos en bindings**
   - **Causa:** Listeners bidireccionales sin protecci√≥n
   - **Mitigaci√≥n:** Mantener flags como `isUpdatingTextFields`, usar `removeListener()` temporalmente

2. **P√©rdida de sincronizaci√≥n UI ‚Üî Estado**
   - **Causa:** Olvidar actualizar ViewModel al cambiar estado
   - **Mitigaci√≥n:** Listeners en ViewModel que disparen [dibujarCanvas()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#731-892), [buildEditPanels()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#161-277)

3. **Referencias a nodos UI desde managers**
   - **Causa:** Managers acceden directamente a `canvas`, `leftPanel`, etc.
   - **Mitigaci√≥n:** Pasar nodos en constructor, usar callbacks para comunicaci√≥n inversa

### ‚ö†Ô∏è **Riesgos Moderados**

4. **Overhead de callbacks**
   - **Causa:** M√∫ltiples callbacks para comunicaci√≥n entre capas
   - **Mitigaci√≥n:** Usar eventos JavaFX (`EventBus` pattern) si se vuelve inmanejable

5. **Duplicaci√≥n de constantes**
   - **Causa:** `CARD_WIDTH`, etc. usadas en m√∫ltiples clases
   - **Mitigaci√≥n:** Crear clase `CR80Constants` o `EditorConfig` compartida

---

## 9Ô∏è‚É£ SIGUIENTES PASOS (POST-REFACTOR)

### üîÆ **Mejoras Futuras**

1. **Implementar persistencia real**
   - Crear `ProjectService` con save/load
   - Usar JSON o serializaci√≥n Java

2. **Implementar exportaci√≥n real**
   - Crear `ExportService`
   - Generar PNG/PDF con resoluci√≥n configurable

3. **Mejorar testabilidad**
   - Crear tests unitarios para ViewModels
   - Crear tests de integraci√≥n para Services
   - Mockear UI para testear Controllers

4. **Optimizar rendering**
   - Cachear renders de elementos
   - Usar [Canvas](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/view/MainViewController.java#110-130) layers para evitar redibujar todo

5. **A√±adir Undo/Redo**
   - Implementar Command pattern
   - Stack de comandos en ViewModel

6. **Mejorar UX**
   - Drag & drop desde toolbox
   - Snap to grid
   - Alineaci√≥n autom√°tica
   - Shortcuts de teclado

---

## üéØ CONCLUSI√ìN

### Estado Actual
- **1594 l√≠neas** en un solo Controller
- **God Object** con 6 responsabilidades mezcladas
- **Imposible de testear** sin JavaFX
- **Fr√°gil** ante cambios

### Estado Objetivo
- **~250 l√≠neas** en MainViewController (orquestaci√≥n)
- **5 clases especializadas** con responsabilidad √∫nica
- **2 ViewModels** con estado observable
- **Testeable** sin UI
- **Mantenible** y extensible

### Esfuerzo Estimado
- **Total:** ~14 horas
- **Por paso:** 2-4 horas
- **Validaci√≥n:** ~1 hora por paso

### Beneficios
- ‚úÖ Separaci√≥n clara de concerns
- ‚úÖ Testabilidad mejorada
- ‚úÖ Mantenibilidad mejorada
- ‚úÖ Escalabilidad para nuevas features
- ‚úÖ Cumplimiento de MVVM

---

**¬øProceder con el refactor?** Espero tu confirmaci√≥n para empezar con el **PASO 1**.
