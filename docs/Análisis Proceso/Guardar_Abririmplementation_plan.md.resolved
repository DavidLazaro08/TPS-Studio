# Plan de Implementaci√≥n: Sistema de Proyectos Profesional

## üéØ Objetivo

Crear un flujo de trabajo profesional para gesti√≥n de proyectos con estructura de carpetas autom√°tica y persistencia.

---

## üìã Flujo de Usuario Deseado

### **1. Crear Nuevo Proyecto**

```
Usuario hace clic en "Nuevo Proyecto"
    ‚Üì
Se abre di√°logo "Nuevo Proyecto TPS"
    ‚îú‚îÄ Campo: Nombre del proyecto (ej: "Tarjetas Corporativas 2024")
    ‚îú‚îÄ Bot√≥n: Seleccionar ubicaci√≥n (DirectoryChooser)
    ‚îî‚îÄ Checkbox: "Vincular base de datos" (opcional)
        ‚îî‚îÄ Si marcado: FileChooser para .xlsx o .accdb
    ‚Üì
Usuario hace clic en "Crear"
    ‚Üì
Sistema crea estructura:
    TPS_Tarjetas_Corporativas_2024/
    ‚îú‚îÄ‚îÄ proyecto.tps (archivo JSON)
    ‚îú‚îÄ‚îÄ Fotos/
    ‚îú‚îÄ‚îÄ Fondos/
    ‚îî‚îÄ‚îÄ BBDD/ (si se vincul√≥ BD)
        ‚îî‚îÄ‚îÄ datos.xlsx (copia)
    ‚Üì
Proyecto se abre autom√°ticamente en modo DISE√ëO
```

### **2. A√±adir Im√°genes/Fondos**

```
Usuario a√±ade imagen desde cualquier ubicaci√≥n
    ‚Üì
Sistema copia autom√°ticamente a:
    - Im√°genes ‚Üí TPS_NombreProyecto/Fotos/
    - Fondos ‚Üí TPS_NombreProyecto/Fondos/
    ‚Üì
.tps guarda ruta RELATIVA: "Fotos/logo.png"
```

### **3. Guardar Proyecto**

```
Usuario hace clic en "Guardar" (Ctrl+S)
    ‚Üì
Sistema actualiza proyecto.tps
    ‚Üì
Confirmaci√≥n: "Proyecto guardado"
```

### **4. Abrir Proyecto**

```
Usuario hace clic en "Abrir Proyecto"
    ‚Üì
FileChooser filtra solo .tps
    ‚Üì
Usuario selecciona proyecto.tps
    ‚Üì
Sistema carga proyecto y verifica im√°genes
    ‚Üì
Si falta alguna imagen: Di√°logo de advertencia
```

---

## üèóÔ∏è Arquitectura de Implementaci√≥n

### **Nuevas Clases**

```
com.tpsstudio.model/
‚îú‚îÄ‚îÄ ProyectoMetadata.java (nuevo)
‚îÇ   - String nombre
‚îÇ   - String ubicacion (path absoluto)
‚îÇ   - String rutaTPS
‚îÇ   - String rutaFotos
‚îÇ   - String rutaFondos
‚îÇ   - String rutaBBDD (opcional)
‚îÇ   - LocalDateTime fechaCreacion
‚îÇ   - LocalDateTime fechaModificacion

com.tpsstudio.service/
‚îú‚îÄ‚îÄ ProyectoFileManager.java (nuevo)
‚îÇ   - crearEstructuraCarpetas()
‚îÇ   - copiarImagenAProyecto()
‚îÇ   - guardarProyecto()
‚îÇ   - cargarProyecto()
‚îÇ   - validarIntegridad()

com.tpsstudio.view/
‚îú‚îÄ‚îÄ NuevoProyectoDialog.java (nuevo)
‚îÇ   - Di√°logo personalizado JavaFX
‚îÇ   - Campos: nombre, ubicaci√≥n, BD
```

---

## üìù Especificaci√≥n Detallada

### **1. Di√°logo "Nuevo Proyecto"**

**Archivo**: `NuevoProyectoDialog.java`

```java
public class NuevoProyectoDialog extends Dialog<ProyectoMetadata> {
    
    private TextField txtNombre;
    private TextField txtUbicacion;
    private CheckBox chkVincularBD;
    private TextField txtRutaBD;
    private Button btnSeleccionarUbicacion;
    private Button btnSeleccionarBD;
    
    public NuevoProyectoDialog() {
        setTitle("Nuevo Proyecto TPS");
        setHeaderText("Crear nuevo proyecto de dise√±o");
        
        // Construir UI
        GridPane grid = new GridPane();
        
        // Nombre del proyecto
        Label lblNombre = new Label("Nombre del proyecto:");
        txtNombre = new TextField();
        txtNombre.setPromptText("Ej: Tarjetas Corporativas 2024");
        
        // Ubicaci√≥n
        Label lblUbicacion = new Label("Ubicaci√≥n:");
        HBox hboxUbicacion = new HBox(5);
        txtUbicacion = new TextField();
        txtUbicacion.setEditable(false);
        txtUbicacion.setPromptText("Seleccione una carpeta...");
        btnSeleccionarUbicacion = new Button("Examinar...");
        btnSeleccionarUbicacion.setOnAction(e -> seleccionarUbicacion());
        hboxUbicacion.getChildren().addAll(txtUbicacion, btnSeleccionarUbicacion);
        
        // Vincular BD (opcional)
        chkVincularBD = new CheckBox("Vincular base de datos (opcional)");
        HBox hboxBD = new HBox(5);
        txtRutaBD = new TextField();
        txtRutaBD.setEditable(false);
        txtRutaBD.setDisable(true);
        btnSeleccionarBD = new Button("Examinar...");
        btnSeleccionarBD.setDisable(true);
        btnSeleccionarBD.setOnAction(e -> seleccionarBD());
        hboxBD.getChildren().addAll(txtRutaBD, btnSeleccionarBD);
        
        chkVincularBD.selectedProperty().addListener((obs, old, newVal) -> {
            txtRutaBD.setDisable(!newVal);
            btnSeleccionarBD.setDisable(!newVal);
        });
        
        // Layout
        grid.add(lblNombre, 0, 0);
        grid.add(txtNombre, 1, 0);
        grid.add(lblUbicacion, 0, 1);
        grid.add(hboxUbicacion, 1, 1);
        grid.add(chkVincularBD, 0, 2, 2, 1);
        grid.add(hboxBD, 1, 3);
        
        getDialogPane().setContent(grid);
        
        // Botones
        ButtonType btnCrear = new ButtonType("Crear", ButtonBar.ButtonData.OK_DONE);
        ButtonType btnCancelar = new ButtonType("Cancelar", ButtonBar.ButtonData.CANCEL_CLOSE);
        getDialogPane().getButtonTypes().addAll(btnCrear, btnCancelar);
        
        // Validaci√≥n
        Node btnCrearNode = getDialogPane().lookupButton(btnCrear);
        btnCrearNode.setDisable(true);
        
        txtNombre.textProperty().addListener((obs, old, newVal) -> {
            btnCrearNode.setDisable(newVal.trim().isEmpty() || txtUbicacion.getText().isEmpty());
        });
        
        txtUbicacion.textProperty().addListener((obs, old, newVal) -> {
            btnCrearNode.setDisable(txtNombre.getText().trim().isEmpty() || newVal.isEmpty());
        });
        
        // Convertir resultado
        setResultConverter(buttonType -> {
            if (buttonType == btnCrear) {
                return crearMetadata();
            }
            return null;
        });
    }
    
    private void seleccionarUbicacion() {
        DirectoryChooser dirChooser = new DirectoryChooser();
        dirChooser.setTitle("Seleccionar ubicaci√≥n del proyecto");
        File dir = dirChooser.showDialog(getDialogPane().getScene().getWindow());
        if (dir != null) {
            txtUbicacion.setText(dir.getAbsolutePath());
        }
    }
    
    private void seleccionarBD() {
        FileChooser fileChooser = new FileChooser();
        fileChooser.setTitle("Seleccionar Base de Datos");
        fileChooser.getExtensionFilters().addAll(
            new FileChooser.ExtensionFilter("Excel", "*.xlsx", "*.xls"),
            new FileChooser.ExtensionFilter("Access", "*.accdb", "*.mdb"),
            new FileChooser.ExtensionFilter("Todos", "*.*")
        );
        File file = fileChooser.showOpenDialog(getDialogPane().getScene().getWindow());
        if (file != null) {
            txtRutaBD.setText(file.getAbsolutePath());
        }
    }
    
    private ProyectoMetadata crearMetadata() {
        ProyectoMetadata metadata = new ProyectoMetadata();
        metadata.setNombre(txtNombre.getText().trim());
        metadata.setUbicacion(txtUbicacion.getText());
        
        if (chkVincularBD.isSelected() && !txtRutaBD.getText().isEmpty()) {
            metadata.setRutaBBDD(txtRutaBD.getText());
        }
        
        return metadata;
    }
}
```

---

### **2. Gestor de Archivos del Proyecto**

**Archivo**: `ProyectoFileManager.java`

```java
public class ProyectoFileManager {
    
    /**
     * Crea la estructura de carpetas del proyecto
     * 
     * @param metadata Metadatos del proyecto
     * @return true si se cre√≥ correctamente
     */
    public boolean crearEstructuraCarpetas(ProyectoMetadata metadata) {
        try {
            // Normalizar nombre (quitar caracteres especiales)
            String nombreCarpeta = "TPS_" + normalizarNombre(metadata.getNombre());
            
            // Crear carpeta principal
            Path carpetaProyecto = Paths.get(metadata.getUbicacion(), nombreCarpeta);
            Files.createDirectories(carpetaProyecto);
            
            // Crear subcarpetas
            Path carpetaFotos = carpetaProyecto.resolve("Fotos");
            Path carpetaFondos = carpetaProyecto.resolve("Fondos");
            Path carpetaBBDD = carpetaProyecto.resolve("BBDD");
            
            Files.createDirectories(carpetaFotos);
            Files.createDirectories(carpetaFondos);
            Files.createDirectories(carpetaBBDD);
            
            // Actualizar metadata con rutas
            metadata.setRutaTPS(carpetaProyecto.resolve("proyecto.tps").toString());
            metadata.setRutaFotos(carpetaFotos.toString());
            metadata.setRutaFondos(carpetaFondos.toString());
            
            // Si hay BD, copiarla
            if (metadata.getRutaBBDD() != null) {
                Path bdOrigen = Paths.get(metadata.getRutaBBDD());
                Path bdDestino = carpetaBBDD.resolve(bdOrigen.getFileName());
                Files.copy(bdOrigen, bdDestino, StandardCopyOption.REPLACE_EXISTING);
                metadata.setRutaBBDD(bdDestino.toString());
            }
            
            return true;
            
        } catch (IOException e) {
            e.printStackTrace();
            return false;
        }
    }
    
    /**
     * Copia una imagen al proyecto y devuelve la ruta relativa
     */
    public String copiarImagenAProyecto(File imagenOrigen, ProyectoMetadata metadata, boolean esFondo) {
        try {
            String carpetaDestino = esFondo ? metadata.getRutaFondos() : metadata.getRutaFotos();
            Path destino = Paths.get(carpetaDestino, imagenOrigen.getName());
            
            // Copiar archivo
            Files.copy(imagenOrigen.toPath(), destino, StandardCopyOption.REPLACE_EXISTING);
            
            // Devolver ruta relativa
            String subcarpeta = esFondo ? "Fondos" : "Fotos";
            return subcarpeta + "/" + imagenOrigen.getName();
            
        } catch (IOException e) {
            e.printStackTrace();
            return null;
        }
    }
    
    /**
     * Guarda el proyecto en formato JSON
     */
    public boolean guardarProyecto(Proyecto proyecto, ProyectoMetadata metadata) {
        try {
            // Crear objeto JSON
            Gson gson = new GsonBuilder().setPrettyPrinting().create();
            
            // Crear DTO para serializaci√≥n
            ProyectoDTO dto = new ProyectoDTO();
            dto.setNombre(proyecto.getNombre());
            dto.setMetadata(metadata);
            dto.setFrente(convertirCaraADTO(proyecto.getFrente()));
            dto.setDorso(convertirCaraADTO(proyecto.getDorso()));
            
            // Escribir a archivo
            String json = gson.toJson(dto);
            Files.writeString(Paths.get(metadata.getRutaTPS()), json);
            
            // Actualizar fecha de modificaci√≥n
            metadata.setFechaModificacion(LocalDateTime.now());
            
            return true;
            
        } catch (IOException e) {
            e.printStackTrace();
            return false;
        }
    }
    
    /**
     * Carga un proyecto desde archivo .tps
     */
    public Proyecto cargarProyecto(File archivoTPS) {
        try {
            // Leer JSON
            String json = Files.readString(archivoTPS.toPath());
            Gson gson = new Gson();
            ProyectoDTO dto = gson.fromJson(json, ProyectoDTO.class);
            
            // Reconstruir proyecto
            Proyecto proyecto = new Proyecto(dto.getNombre());
            proyecto.setFrente(convertirDTOACara(dto.getFrente(), dto.getMetadata()));
            proyecto.setDorso(convertirDTOACara(dto.getDorso(), dto.getMetadata()));
            
            // Validar integridad de im√°genes
            validarIntegridad(proyecto, dto.getMetadata());
            
            return proyecto;
            
        } catch (IOException e) {
            e.printStackTrace();
            return null;
        }
    }
    
    /**
     * Valida que todas las im√°genes existan
     */
    private void validarIntegridad(Proyecto proyecto, ProyectoMetadata metadata) {
        List<String> imagenesFaltantes = new ArrayList<>();
        
        // Verificar frente
        verificarImagenesCara(proyecto.getFrente(), metadata, imagenesFaltantes);
        
        // Verificar dorso
        verificarImagenesCara(proyecto.getDorso(), metadata, imagenesFaltantes);
        
        // Mostrar advertencia si faltan im√°genes
        if (!imagenesFaltantes.isEmpty()) {
            Platform.runLater(() -> {
                Alert alert = new Alert(Alert.AlertType.WARNING);
                alert.setTitle("Im√°genes faltantes");
                alert.setHeaderText("Algunas im√°genes no se encontraron");
                alert.setContentText("Archivos faltantes:\n" + String.join("\n", imagenesFaltantes));
                alert.showAndWait();
            });
        }
    }
    
    private String normalizarNombre(String nombre) {
        return nombre.replaceAll("[^a-zA-Z0-9_\\-]", "_");
    }
}
```

---

### **3. Integraci√≥n en ProjectManager**

**Modificar**: [ProjectManager.java](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/service/ProjectManager.java)

```java
public class ProjectManager {
    
    private ProyectoFileManager fileManager;
    
    public ProjectManager() {
        this.fileManager = new ProyectoFileManager();
    }
    
    /**
     * Crea un nuevo proyecto con di√°logo y estructura de carpetas
     */
    public Proyecto nuevoProyecto(Window owner) {
        // Mostrar di√°logo
        NuevoProyectoDialog dialog = new NuevoProyectoDialog();
        Optional<ProyectoMetadata> result = dialog.showAndWait();
        
        if (result.isEmpty()) {
            return null; // Usuario cancel√≥
        }
        
        ProyectoMetadata metadata = result.get();
        
        // Crear estructura de carpetas
        if (!fileManager.crearEstructuraCarpetas(metadata)) {
            mostrarError("No se pudo crear la estructura de carpetas");
            return null;
        }
        
        // Crear proyecto
        Proyecto nuevoProyecto = new Proyecto(metadata.getNombre());
        nuevoProyecto.setMetadata(metadata);
        
        // Guardar proyecto inicial
        if (!fileManager.guardarProyecto(nuevoProyecto, metadata)) {
            mostrarError("No se pudo guardar el proyecto");
            return null;
        }
        
        // A√±adir a lista
        proyectos.add(nuevoProyecto);
        setProyectoActual(nuevoProyecto);
        
        // Notificar
        if (onProjectChanged != null) {
            onProjectChanged.run();
        }
        
        return nuevoProyecto;
    }
    
    /**
     * A√±ade imagen y la copia al proyecto
     */
    @Override
    public ImagenElemento a√±adirImagen(Window window) {
        if (proyectoActual == null) return null;
        
        FileChooser fileChooser = new FileChooser();
        fileChooser.setTitle("Seleccionar Imagen");
        fileChooser.getExtensionFilters().addAll(
            new FileChooser.ExtensionFilter("Im√°genes", "*.png", "*.jpg", "*.jpeg", "*.gif")
        );
        
        File file = fileChooser.showOpenDialog(window);
        if (file == null) return null;
        
        try {
            // Copiar imagen al proyecto
            ProyectoMetadata metadata = proyectoActual.getMetadata();
            String rutaRelativa = fileManager.copiarImagenAProyecto(file, metadata, false);
            
            if (rutaRelativa == null) {
                mostrarErrorCargaImagen("No se pudo copiar la imagen al proyecto");
                return null;
            }
            
            // Cargar imagen
            Path rutaAbsoluta = Paths.get(metadata.getRutaTPS()).getParent().resolve(rutaRelativa);
            Image img = new Image(rutaAbsoluta.toUri().toString());
            
            // Crear elemento
            int num = proyectoActual.getElementosActuales().size() + 1;
            ImagenElemento imgElem = new ImagenElemento(
                "Imagen " + num, 
                50, 50,
                rutaRelativa, // Guardar ruta RELATIVA
                img
            );
            
            proyectoActual.getElementosActuales().add(imgElem);
            
            // Auto-guardar
            fileManager.guardarProyecto(proyectoActual, metadata);
            
            if (onElementAdded != null) {
                onElementAdded.run();
            }
            
            return imgElem;
            
        } catch (Exception ex) {
            ex.printStackTrace();
            mostrarErrorCargaImagen(ex.getMessage());
            return null;
        }
    }
}
```

---

## üìã Checklist de Implementaci√≥n

### **Fase 1: Modelo y Utilidades** (2-3h)
- [ ] Crear `ProyectoMetadata.java`
- [ ] Crear `ProyectoDTO.java` (para JSON)
- [ ] A√±adir campo `metadata` a `Proyecto.java`
- [ ] Crear `ProyectoFileManager.java`
- [ ] Implementar `crearEstructuraCarpetas()`
- [ ] Implementar `normalizarNombre()`

### **Fase 2: Di√°logo de Nuevo Proyecto** (3-4h)
- [ ] Crear `NuevoProyectoDialog.java`
- [ ] Dise√±ar UI (GridPane con campos)
- [ ] Implementar `seleccionarUbicacion()` (DirectoryChooser)
- [ ] Implementar `seleccionarBD()` (FileChooser)
- [ ] Validaci√≥n de campos
- [ ] Convertir resultado a `ProyectoMetadata`

### **Fase 3: Integraci√≥n en ProjectManager** (2-3h)
- [ ] Modificar `nuevoProyecto()` para usar di√°logo
- [ ] Modificar [a√±adirImagen()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/service/ProjectManager.java#130-169) para copiar a carpeta Fotos
- [ ] Modificar [a√±adirFondo()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/service/ProjectManager.java#170-240) para copiar a carpeta Fondos
- [ ] Implementar auto-guardado despu√©s de cada cambio

### **Fase 4: Serializaci√≥n JSON** (3-4h)
- [ ] A√±adir dependencia Gson al [pom.xml](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/pom.xml)
- [ ] Crear DTOs para serializaci√≥n
- [ ] Implementar [guardarProyecto()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/service/ProjectManager.java#92-98)
- [ ] Implementar `cargarProyecto()`
- [ ] Implementar `validarIntegridad()`

### **Fase 5: Abrir Proyecto** (2h)
- [ ] Modificar [abrirProyecto()](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/service/ProjectManager.java#85-91) en [ProjectManager](file:///c:/Users/Usuario/Documents/Grado%20S%20Programaci%C3%B3n%20-%20SEGUNDO/00%20PROYECTO%20FINAL/TPS_STUDIO_APP/TPS_Studio/tps-studio/src/main/java/com/tpsstudio/service/ProjectManager.java#24-294)
- [ ] FileChooser con filtro `.tps`
- [ ] Cargar proyecto y reconstruir objetos
- [ ] Validar im√°genes faltantes

### **Fase 6: Testing** (2h)
- [ ] Crear proyecto nuevo
- [ ] A√±adir im√°genes/fondos
- [ ] Verificar que se copian a carpetas correctas
- [ ] Guardar proyecto
- [ ] Cerrar app
- [ ] Abrir proyecto
- [ ] Verificar que todo se carga correctamente

---

## ‚è±Ô∏è Tiempo Estimado Total

**14-18 horas** (2-3 d√≠as de trabajo)

---

## üéØ Resultado Final

Al completar, tendr√°s:

‚úÖ Di√°logo profesional para crear proyectos  
‚úÖ Estructura de carpetas autom√°tica  
‚úÖ Im√°genes organizadas en subcarpetas  
‚úÖ Archivo `.tps` con rutas relativas  
‚úÖ Guardar/Abrir proyectos funcional  
‚úÖ Validaci√≥n de integridad  
‚úÖ Base para vincular BD (futuro)

---

## üí° Pr√≥ximos Pasos Despu√©s

1. **Auto-guardado** cada X minutos
2. **Historial de proyectos recientes**
3. **Exportaci√≥n a PDF/PNG** (usando rutas del proyecto)
4. **Campos variables** (usando BD vinculada)
